name: Build

on:
  push:
    branches:
      - main
jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: [1.14, 1.15]
    
    steps:
      - uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}

      - name: Install SonarScanner
        run: |
          echo "Installing SonarScanner..."
          sudo apt-get update
          sudo apt-get install -y unzip openjdk-11-jre
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner-cli-5.0.1.3006-linux.zip
          sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
          echo "SONAR_SCANNER_HOME=/opt/sonar-scanner" >> $GITHUB_ENV
          echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Build Project
        run: |
          echo "Compiling..."
          go build -v ./...


  check-applications:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run SonarScanner CLI
        run: |
          sonar-scanner \
            -Dsonar.projectKey=go-project \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://localhost:9000
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

